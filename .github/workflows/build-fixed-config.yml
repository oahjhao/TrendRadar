name: Build Fixed Config Image

on:
  workflow_dispatch:  # æ‰‹åŠ¨è§¦å‘
  push:
    branches: [ "master" ]
    paths:
      - 'docker/Dockerfile.fixed-config'
      - 'config/config.yaml'

env:
  AWS_REGION: us-west-2
  ECR_REGISTRY: 648104168728.dkr.ecr.us-west-2.amazonaws.com
  ECR_REPOSITORY: shanavasa/trendradar-app
  IMAGE_TAG: fixed-config

jobs:
  build-fixed:
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Configure AWS credentials via OIDC
      uses: aws-actions/configure-aws-credentials@v4
      with:
        role-to-assume: arn:aws:iam::648104168728:role/github-actions-trendradar
        aws-region: ${{ env.AWS_REGION }}
        role-session-name: GitHubActionsTrendRadarFixed-${{ github.run_id }}
    
    - name: Login to Amazon ECR
      id: login-ecr
      uses: aws-actions/amazon-ecr-login@v2
      with:
        registry-type: private
    
    - name: Verify config fixes
      run: |
        echo "éªŒè¯é…ç½®æ–‡ä»¶ä¿®å¤..."
        echo "1. æ£€æŸ¥é¢‘çŽ‡è¯æ–‡ä»¶:"
        cat config/frequency_words.txt | wc -l
        echo "2. æ£€æŸ¥é€šçŸ¥é…ç½®:"
        grep "enable_notification" config/config.yaml
        echo "3. æ£€æŸ¥é’‰é’‰URL:"
        grep "dingtalk_url" config/config.yaml
    
    - name: Build Fixed Config Docker image
      run: |
        TIMESTAMP=$(date +%Y%m%d-%H%M%S)
        echo "TIMESTAMP=$TIMESTAMP" >> $GITHUB_ENV
        
        echo "æž„å»ºä¿®å¤ç‰ˆé•œåƒ..."
        docker build \
          -f docker/Dockerfile.fixed-config \
          -t ${{ env.ECR_REGISTRY }}/${{ env.ECR_REPOSITORY }}:${{ env.IMAGE_TAG }} \
          -t ${{ env.ECR_REGISTRY }}/${{ env.ECR_REPOSITORY }}:fixed-$TIMESTAMP \
          .
        
        echo "âœ… é•œåƒæž„å»ºå®Œæˆ"
    
    - name: Push Docker image
      run: |
        echo "æŽ¨é€é•œåƒåˆ°ECR..."
        docker push ${{ env.ECR_REGISTRY }}/${{ env.ECR_REPOSITORY }}:${{ env.IMAGE_TAG }}
        docker push ${{ env.ECR_REGISTRY }}/${{ env.ECR_REPOSITORY }}:fixed-$TIMESTAMP
        
        echo "âœ… é•œåƒæŽ¨é€å®Œæˆ"
    
    - name: Verify and list images
      run: |
        echo "éªŒè¯æŽ¨é€ç»“æžœ..."
        aws ecr describe-images \
          --repository-name ${{ env.ECR_REPOSITORY }} \
          --region ${{ env.AWS_REGION }} \
          --query 'sort_by(imageDetails, &imagePushedAt)[-5:].[imageTags, imagePushedAt]' \
          --output table 2>/dev/null || echo "æ£€æŸ¥é•œåƒåˆ—è¡¨"
    
    - name: Create deployment summary
      if: always()
      run: |
        echo "## TrendRadar ä¿®å¤ç‰ˆé•œåƒæž„å»ºæŠ¥å‘Š" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ› ï¸ ä¿®å¤å†…å®¹" >> $GITHUB_STEP_SUMMARY
        echo "- **ç¦ç”¨é€šçŸ¥**: \`enable_notification: false\`" >> $GITHUB_STEP_SUMMARY
        echo "- **æ¸…ç©ºé’‰é’‰URL**: \`dingtalk_url: \"\"\`" >> $GITHUB_STEP_SUMMARY
        echo "- **ç¦ç”¨é»˜è®¤çƒ­ç‚¹**: ç©ºé¢‘çŽ‡è¯æ–‡ä»¶" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### âœ… æž„å»ºä¿¡æ¯" >> $GITHUB_STEP_SUMMARY
        echo "- **é•œåƒ**: \`${{ env.ECR_REGISTRY }}/${{ env.ECR_REPOSITORY }}:${{ env.IMAGE_TAG }}\`" >> $GITHUB_STEP_SUMMARY
        echo "- **æ—¶é—´æˆ³æ ‡ç­¾**: \`fixed-$TIMESTAMP\`" >> $GITHUB_STEP_SUMMARY
        echo "- **Dockerfile**: \`docker/Dockerfile.fixed-config\`" >> $GITHUB_STEP_SUMMARY
        echo "- **è§¦å‘æ—¶é—´**: $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸš€ ä¸‹ä¸€æ­¥æ“ä½œ" >> $GITHUB_STEP_SUMMARY
        echo "1. **åˆ›å»ºæ–°ä»»åŠ¡å®šä¹‰**: \`trendradar-on-demand:4\` ä½¿ç”¨æ–°é•œåƒ" >> $GITHUB_STEP_SUMMARY
        echo "2. **æ›´æ–°ECSæœåŠ¡**: éƒ¨ç½²ä¿®å¤ç‰ˆ" >> $GITHUB_STEP_SUMMARY
        echo "3. **æµ‹è¯•éªŒè¯**: å‘é€é’‰é’‰å‘½ä»¤æµ‹è¯•" >> $GITHUB_STEP_SUMMARY
        echo "4. **éªŒè¯éœ€æ±‚**: ç¡®è®¤æ— é»˜è®¤çƒ­ç‚¹æŽ¨é€ï¼ŒåªæŽ¨é€æ£€ç´¢å†…å®¹" >> $GITHUB_STEP_SUMMARY