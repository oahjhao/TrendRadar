name: Test IAM Role Configuration

on:
  workflow_dispatch:  # ä»…æ‰‹åŠ¨è§¦å‘

env:
  AWS_REGION: us-west-2
  ECR_REGISTRY: 648104168728.dkr.ecr.us-west-2.amazonaws.com
  ECR_REPOSITORY: shanavasa/trendradar-app
  ROLE_ARN: arn:aws:iam::648104168728:role/github-actions-trendradar

jobs:
  test-iam-role:
    runs-on: ubuntu-latest
    permissions:
      id-token: write  # å¿…é¡»çš„ï¼Œç”¨äºŽ OIDC
      contents: read   # å¿…é¡»çš„ï¼Œç”¨äºŽä»£ç æ£€å‡º
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Configure AWS credentials via OIDC
      uses: aws-actions/configure-aws-credentials@v4
      with:
        role-to-assume: ${{ env.ROLE_ARN }}
        aws-region: ${{ env.AWS_REGION }}
        role-session-name: GitHubActionsTest-${{ github.run_id }}
    
    - name: Test AWS credentials
      run: |
        echo "âœ… AWS å‡­è¯é…ç½®æˆåŠŸ"
        echo "æµ‹è¯•èŽ·å–è°ƒç”¨è€…èº«ä»½..."
        aws sts get-caller-identity
        
        echo ""
        echo "ðŸ“‹ è°ƒç”¨è€…ä¿¡æ¯:"
        USER_ID=$(aws sts get-caller-identity --query UserId --output text)
        ACCOUNT=$(aws sts get-caller-identity --query Account --output text)
        ARN=$(aws sts get-caller-identity --query Arn --output text)
        
        echo "ç”¨æˆ·ID: $USER_ID"
        echo "è´¦æˆ·: $ACCOUNT"
        echo "ARN: $ARN"
        
        # éªŒè¯ Role è¢«æ­£ç¡® Assume
        if [[ $ARN == *"github-actions-trendradar"* ]]; then
          echo "âœ… æˆåŠŸ Assume åˆ°æ­£ç¡®çš„ Role"
        else
          echo "âŒ æœª Assume åˆ°æ­£ç¡®çš„ Role"
          exit 1
        fi
    
    - name: Test ECR permissions
      run: |
        echo ""
        echo "ðŸ”§ æµ‹è¯• ECR æƒé™..."
        
        # æµ‹è¯• GetAuthorizationTokenï¼ˆåŸºç¡€æƒé™ï¼‰
        echo "1. æµ‹è¯• ECR GetAuthorizationToken..."
        if aws ecr get-authorization-token --region ${{ env.AWS_REGION }} --query 'authorizationData[].authorizationToken' --output text > /dev/null 2>&1; then
          echo "   âœ… ECR GetAuthorizationToken æƒé™æ­£å¸¸"
        else
          echo "   âŒ ECR GetAuthorizationToken æƒé™å¤±è´¥"
          exit 1
        fi
        
        # æµ‹è¯• DescribeRepositories
        echo "2. æµ‹è¯• ECR DescribeRepositories..."
        if aws ecr describe-repositories --repository-names ${{ env.ECR_REPOSITORY }} --region ${{ env.AWS_REGION }} > /dev/null 2>&1; then
          echo "   âœ… ECR ä»“åº“å­˜åœ¨ä¸”å¯è®¿é—®"
          REPO_URI=$(aws ecr describe-repositories --repository-names ${{ env.ECR_REPOSITORY }} --query 'repositories[0].repositoryUri' --output text --region ${{ env.AWS_REGION }})
          echo "   ä»“åº“ URI: $REPO_URI"
        else
          echo "   âš ï¸ ECR ä»“åº“å¯èƒ½ä¸å­˜åœ¨æˆ–æ— è®¿é—®æƒé™"
          echo "   é”™è¯¯ä»£ç : $?"
        fi
        
        # æµ‹è¯•åˆ—å‡ºæ‰€æœ‰ä»“åº“ï¼ˆå¦‚æžœæœ‰æƒé™ï¼‰
        echo "3. æµ‹è¯•åˆ—å‡º ECR ä»“åº“..."
        REPO_COUNT=$(aws ecr describe-repositories --region ${{ env.AWS_REGION }} --query 'repositories | length(@)' --output text 2>/dev/null || echo "0")
        echo "   å¯è®¿é—®çš„ä»“åº“æ•°é‡: $REPO_COUNT"
    
    - name: Create test report
      if: always()
      run: |
        echo "## IAM Role æµ‹è¯•æŠ¥å‘Š" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### æµ‹è¯•æ—¶é—´: $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        # èŽ·å–æµ‹è¯•ç»“æžœ
        echo "### ðŸŽ¯ æµ‹è¯•ç»“æžœ" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        # æ£€æŸ¥æ˜¯å¦æˆåŠŸ Assume Role
        if aws sts get-caller-identity --query Arn --output text 2>/dev/null | grep -q "github-actions-trendradar"; then
          echo "- âœ… **IAM Role Assume æˆåŠŸ**" >> $GITHUB_STEP_SUMMARY
          ROLE_ARN=$(aws sts get-caller-identity --query Arn --output text 2>/dev/null)
          echo "  - Role ARN: \`$ROLE_ARN\`" >> $GITHUB_STEP_SUMMARY
        else
          echo "- âŒ **IAM Role Assume å¤±è´¥**" >> $GITHUB_STEP_SUMMARY
        fi
        
        # æ£€æŸ¥ ECR æƒé™
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ” ECR æƒé™æµ‹è¯•" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        if aws ecr get-authorization-token --region ${{ env.AWS_REGION }} --query 'authorizationData[].authorizationToken' --output text > /dev/null 2>&1; then
          echo "- âœ… **ECR åŸºç¡€æƒé™æ­£å¸¸**" >> $GITHUB_STEP_SUMMARY
        else
          echo "- âŒ **ECR åŸºç¡€æƒé™å¤±è´¥**" >> $GITHUB_STEP_SUMMARY
        fi
        
        # æ£€æŸ¥ä»“åº“è®¿é—®
        if aws ecr describe-repositories --repository-names ${{ env.ECR_REPOSITORY }} --region ${{ env.AWS_REGION }} > /dev/null 2>&1; then
          echo "- âœ… **ECR ä»“åº“å¯è®¿é—®**" >> $GITHUB_STEP_SUMMARY
          REPO_URI=$(aws ecr describe-repositories --repository-names ${{ env.ECR_REPOSITORY }} --query 'repositories[0].repositoryUri' --output text --region ${{ env.AWS_REGION }} 2>/dev/null || echo "æœªçŸ¥")
          echo "  - ä»“åº“ URI: \`$REPO_URI\`" >> $GITHUB_STEP_SUMMARY
        else
          echo "- âš ï¸ **ECR ä»“åº“è®¿é—®å¤±è´¥**" >> $GITHUB_STEP_SUMMARY
          echo "  - å¯èƒ½åŽŸå› : ä»“åº“ä¸å­˜åœ¨æˆ–æƒé™ä¸è¶³" >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸš€ ä¸‹ä¸€æ­¥" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "1. å¦‚æžœæ‰€æœ‰æµ‹è¯•é€šè¿‡ï¼Œå¯ä»¥è¿è¡Œå®Œæ•´çš„æž„å»º workflow" >> $GITHUB_STEP_SUMMARY
        echo "2. å¦‚æžœæœ‰æƒé™é—®é¢˜ï¼Œéœ€è¦è°ƒæ•´ IAM Role ç­–ç•¥" >> $GITHUB_STEP_SUMMARY
        echo "3. å¦‚æžœä»“åº“ä¸å­˜åœ¨ï¼Œéœ€è¦åˆ›å»º ECR ä»“åº“" >> $GITHUB_STEP_SUMMARY
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ”§ é…ç½®ä¿¡æ¯" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "- **Role ARN**: \`${{ env.ROLE_ARN }}\`" >> $GITHUB_STEP_SUMMARY
        echo "- **AWS åŒºåŸŸ**: ${{ env.AWS_REGION }}" >> $GITHUB_STEP_SUMMARY
        echo "- **ECR ä»“åº“**: ${{ env.ECR_REPOSITORY }}" >> $GITHUB_STEP_SUMMARY
        echo "- **è§¦å‘è€…**: ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
        echo "- **è¿è¡Œ ID**: ${{ github.run_id }}" >> $GITHUB_STEP_SUMMARY